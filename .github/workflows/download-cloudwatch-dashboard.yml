name: Update CloudWatch Dashboard Figures

on:
  workflow_dispatch:

jobs:
  update-figures:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Fetch CloudWatch dashboard JSON
        run: |
          aws cloudwatch get-dashboard \
            --dashboard-name medicalbot-monitoring \
            --output json > dashboard.json

      - name: Extract widget JSONs
        run: |
          # Extract PositiveRate:Feedback widget
          jq -c '.DashboardBody | fromjson | .widgets[] | select(.title=="PositiveRate:Feedback")' dashboard.json > widget-feedback.json
          # Extract PositiveRate:task_status widget
          jq -c '.DashboardBody | fromjson | .widgets[] | select(.title=="PositiveRate:task_status")' dashboard.json > widget-task_status.json

      - name: Generate PNGs
        run: |
          aws cloudwatch get-metric-widget-image \
            --metric-widget file://widget-feedback.json \
            --output text \
            --query 'MetricWidgetImage' \
            | base64 --decode > resources/figures/dashboard-feedback.png

          aws cloudwatch get-metric-widget-image \
            --metric-widget file://widget-task_status.json \
            --output text \
            --query 'MetricWidgetImage' \
            | base64 --decode > resources/figures/dashboard-taskstatus.png

      - name: Commit & push updated figures
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add resources/figures/
          git commit -m "Update CloudWatch dashboard figures"

      - name: Clean up temporary files
        run: |
          rm dashboard.json widget-feedback.json widget-task_status.json