name: Update CloudWatch Dashboard Figures

on:
  workflow_dispatch:

jobs:
  update-figures:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Fetch CloudWatch dashboard JSON
        run: |
          aws cloudwatch get-dashboard \
            --dashboard-name medicalbot-monitoring \
            --output json > dashboard.json

      - name: Extract widget JSONs
        run: |
          # Feedback widget
          jq -c '.DashboardBody | fromjson | .widgets[]
            | select(.properties.title=="PositiveRate:feedback")
            | {metrics: .properties.metrics, stat: "Average", period: 300, region: "us-east-1", title: .properties.title, start:"-PT24H", end:"P0D"}' dashboard.json > widget-feedback.json

          # Task status widget
          jq -c '.DashboardBody | fromjson | .widgets[]
            | select(.properties.title=="PositiveRate:task_status")
            | {metrics: .properties.metrics, stat: "Average", period: 300, region: "us-east-1", title: .properties.title, start:"-PT24H", end:"P0D"}' dashboard.json > widget-task_status.json

          # MeanLength:session_id widget
          jq -c '.DashboardBody | fromjson | .widgets[]
            | select(.properties.title=="MeanLength:Session")
            | {metrics: .properties.metrics, stat: "Average", period: 300, region: "us-east-1", title: .properties.title, start:"-PT24H", end:"P0D"}' dashboard.json > widget-meansessionlength.json

          # TotalCount:Queries widget
          jq -c '.DashboardBody | fromjson | .widgets[]
            | select(.properties.title=="TotalCount:Queries")
            | {metrics: .properties.metrics, stat: "Average", period: 300, region: "us-east-1", title: .properties.title, start:"-PT24H", end:"P0D"}' dashboard.json > widget-totalcountqueries.json

          # TotalCount:Sessions widget
          jq -c '.DashboardBody | fromjson | .widgets[]
            | select(.properties.title=="TotalCount:Sessions")
            | {metrics: .properties.metrics, stat: "Average", period: 300, region: "us-east-1", title: .properties.title, start:"-PT24H", end:"P0D"}' dashboard.json > widget-totalcountsessions.json

          # Mean:InteractionDuration widget
          jq -c '.DashboardBody | fromjson | .widgets[]
            | select(.properties.title=="Mean:InteractionDuration")
            | {metrics: .properties.metrics, stat: "Average", period: 300, region: "us-east-1", title: .properties.title, start:"-PT24H", end:"P0D"}' dashboard.json > widget-meaninteractionduration.json

          # Mean:Duration widget
          jq -c '.DashboardBody | fromjson | .widgets[]
            | select(.properties.title=="Mean:Duration")
            | {metrics: .properties.metrics, stat: "Average", period: 300, region: "us-east-1", title: .properties.title, start:"-PT24H", end:"P0D"}' dashboard.json > widget-meanduration.json

      - name: Generate PNGs
        run: |
          aws cloudwatch get-metric-widget-image \
            --metric-widget file://widget-feedback.json \
            --output text \
            --query 'MetricWidgetImage' \
            | base64 --decode > docs/monitoring/figures/dashboard-feedback.png

          aws cloudwatch get-metric-widget-image \
            --metric-widget file://widget-task_status.json \
            --output text \
            --query 'MetricWidgetImage' \
            | base64 --decode > docs/monitoring/figures/dashboard-taskstatus.png

          aws cloudwatch get-metric-widget-image \
            --metric-widget file://widget-meansessionlength.json \
            --output text \
            --query 'MetricWidgetImage' \
            | base64 --decode > docs/monitoring/figures/dashboard-meansessionlength.png

          aws cloudwatch get-metric-widget-image \
            --metric-widget file://widget-totalcountqueries.json \
            --output text \
            --query 'MetricWidgetImage' \
            | base64 --decode > docs/monitoring/figures/dashboard-totalcountqueries.png

          aws cloudwatch get-metric-widget-image \
            --metric-widget file://widget-totalcountsessions.json \
            --output text \
            --query 'MetricWidgetImage' \
            | base64 --decode > docs/monitoring/figures/dashboard-totalcountsessions.png

          aws cloudwatch get-metric-widget-image \
            --metric-widget file://widget-meaninteractionduration.json \
            --output text \
            --query 'MetricWidgetImage' \
            | base64 --decode > docs/monitoring/figures/dashboard-meaninteractionduration.png

          aws cloudwatch get-metric-widget-image \
            --metric-widget file://widget-meanduration.json \
            --output text \
            --query 'MetricWidgetImage' \
            | base64 --decode > docs/monitoring/figures/dashboard-meanduration.png

      - name: Clean up temporary files
        run: |
          rm dashboard.json widget-feedback.json widget-task_status.json widget-meansessionlength.json widget-totalcountsessions.json widget-totalcountqueries.json widget-meaninteractionduration.json widget-meanduration.json

      - name: Commit & push updated figures
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add docs/monitoring/figures/
          git commit -m "Update CloudWatch dashboard figures"
          git push
